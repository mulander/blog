---
layout: post
title: How to learn a code base - rsync Part 1
date: '2011-05-15T09:46:00.000-07:00'
author: Adam Wo≈Çk
tags:
- programming
- c
- rsync
modified_time: '2011-05-22T15:39:08.136-07:00'
blogger_id: tag:blogger.com,1999:blog-7611594305180455830.post-1282408409644495364
blogger_orig_url: http://homing-on-code.blogspot.com/2011/05/how-to-learn-code-base-rsync-part-1.html
---

<div class="separator" style="clear: both; text-align: center;"><a href="/images/newrsynclogo.jpg" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="http://rsync.samba.org/newrsynclogo.jpg" /></a></div>In the <a href="{{ site.baseurl }}{% post_url 2011-05-07-how-to-learn-code-base-rsync-prologue %}">Prologue</a> of this series we took a birds eye view on rsync based on the information we found on <a href="http://en.wikipedia.org/wiki/Rsync">Wikipedia </a>and the project <a href="http://rsync.samba.org/">homepage</a>. The goal was to achieve a general feel for the project and do the important first step in learning a code base - <b>simply starting</b>.<br />Today we will start navigating the code base. Getting our own copy and compiling it.<br /><br /><a name='more'></a><br /><br /><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><span class="Apple-style-span" style="font-size: x-large;">Table of Contents</span></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><br /></div><ul><li><a href="{{ site.baseurl }}{% post_url 2011-05-07-how-to-learn-code-base-rsync-prologue %}">Prologue - Getting a bird's eye view</a></li><li>Part 1 - This post</li><li><a href="{{ site.baseurl }}{% post_url 2011-05-23-how-to-learn-code-base-rsync-part-2 %}">Part 2 - Making things snappy</a></li></ul><div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><span class="Apple-style-span" style="font-size: x-large;">Part 1 - Getting the source and compiling it</span></div></div><br /><br />Information on how to get the source is one of the most important things for an open source project. The authors didn't fail and provided a great description of several available ways of <a href="http://rsync.samba.org/download.html">getting the code</a>. For our needs a checkout of the git repository will serve the best so let's clone a local copy for ourselves.<br /><br /><code>git clone git://git.samba.org/rsync.git</code><br /><br />The result of this command will be a 28M rsync directory containing the whole history of the project.<br />The first things we look for are files named README, INSTALL, NEWS, TODO - generally anything all caps that could contain notes from the developers to fellow developers.<br /><br />Let's start with the README file. The first part repeats some informations we found previously. In the SETUP section we see that rsync doesn't require setuid or any special privileges - this is a nice usability/security feature.<br /><br />And bingo, the first really important part of information that tells us how to work with the raw code. The file informs us that in order to <i>install</i>&nbsp;rsync, we need to first run the "configure" script. Then type "make" to build the code. The final installation step is just copying the binary on the system path - which can be also done using the make install command. This is a standard sequence with most C projects in the UNIX world.<br /><br />Let's also note another important thing from the README file:<br /><br /><cite>Note that on some systems you will have to force configure not to use<br />gcc because gcc may not support some features (such as 64 bit file<br />offsets) that your system may support. &nbsp;Set the environment variable CC<br />to the name of your native compiler before running configure in this<br />case.</cite><br /><br />That covers the README file at this point. Next stop the INSTALL file.<br />As expected, the installation steps are repeated with an additional pointer showing how to see the optional arguments to the configuration script. It's worth to note that rsync tries to run as the nobody user group when in daemon mode. This default can be changed by editing NOBODY_USER and NOBODY_GROUP in the config.h file or overriding settings in the rsync daemon configuration file (/etc/rsyncd.conf).<br /><br />There is no general list of dependencies the tool has, so we will start maintaining our own. The first library on the dependency list is the popt option-parsing library required since rsync 2.4.7. It's used for parsing the configuration file for the daemon mode. A recent copy of the library is included in the rsync code base and is used by default if the hosting system doesn't have a copy installed. One can force the usage of the bundled version by passing --with-included-popt option to the ./configure script.<br /><br />The file also contains useful information on a rare problem with the make system and several sections devoted to specific platforms and packaging options. We will skip this info for now and stick to the basic installation steps.<br /><br />While reviewing the files we notice the 'Doxyfile' configuration file for the <a href="http://www.stack.nl/~dimitri/doxygen/">doxygen </a>documentation generation utility. This is great news as it means that probably most of the code base will be covered by the tool and the documentation should be decent enough to be of use.<br /><br />I just took a quick look on the README, OLDNEWS and NEWS files. Not searching for anything specific at this point - just getting the feel of the changes and plans for the code. The TODO file has a section on using a generic zlib. From it we can deduce that the zlib shipped with rsync is specific (patched) enough that it is a required bundled dependency.<br /><br />There is one thing missing in the source tree or I didn't find it yet - a one-line description of the purpose and content of each file in the tree. Having a list like this often becomes the most useful part of the documentation of a system. It's terse enough to quickly glance and pick specific parts that might be relevant to the current task at hand. Since we didn't find one - we will start making our own and slowly fill it out with information.<br /><br />I used the tree utility to generate the initial list, place it under version control and work on it from there. You can <a href="https://github.com/mulander/lac/blob/master/rsync/tree.txt">track </a>the progress on <a href="https://github.com/mulander/lac/blob/master/rsync/rsync.org">github</a>.<br /><br />We can proceed to building the source since we gathered the initial required information.<br /><br />Let's run ./configure without any parameters at first. In my case, the script reported a successful configuration so let's proceed to running make.<br /><br />Unfortunately we got our first problem.<br /><br /><code>./rsync.h:669:26: fatal error: linux/falloc.h: No such file or directory</code><br /><br />A quick search revealed that falloc is a linux header file providing functions for direct manipulation of file space. The file seems not to be present on my test system - a Slackware GNU/Linux running a grsec kernel 2.6.32.7 - at least not in /usr/include/linux/falloc.h.<br /><br />The include comes from rsync.h on line 669 and is guarded by conditional compilation. The file is only included if the configuration utility set the HAVE_FALLOCATE or HAVE_SYS_FALLOCATE constants to a true value.<br /><br />We need to check the config.log to see what made the system think the library is available.<br /><br /><code><br />configure.sh:7521: checking for posix_fallocate<br />configure.sh:7521: gcc -std=gnu99 -o conftest -g -O2 -DHAVE_CONFIG_H -Wall -W &nbsp; conftest.c &nbsp;&gt;&amp;5<br />configure.sh:7521: $? = 0<br />configure.sh:7521: result: yes<br />configure.sh:7541: checking for useable fallocate<br />configure.sh:7559: gcc -std=gnu99 -o conftest -g -O2 -DHAVE_CONFIG_H -Wall -W &nbsp; conftest.c &nbsp;&gt;&amp;5<br />configure.sh:7559: $? = 0<br />configure.sh:7567: result: yes<br /></code><br /><div><br /></div><div>From the listing above we can see that a set of tests decided that POSIX fallocate is available. A further set of tests shows that the SYS fallocate is not available and not usable. Hence we need to see what made the POSIX one pass the configuration point and fail when compiling the code.<br /><br />In the generated config.h file (created by the ./configure step) we can confirm the output of the config.log by seeing that HAVE_FALLOCATE is defined and set to 1. The same can be said about HAVE_POSIX_FALLOCATE. According to our expectations HAVE_SYS_FALLOCATE remains undefined.<br /><br />Let's check configure.sh to see what code was generated that run correctly and how it differs to rsync.h<br /><br /><code><br />#include &lt;fcntl.h&gt;<br />#include &lt;sys/types.h&gt;<br />int<br />main ()<br />{<br />fallocate(0, 0, 0, 0);<br />&nbsp; ;<br />&nbsp; return 0;<br />}<br /></code><br /><div><br /></div><div>Let's save this to test.c, compile and run<br /><br /><code><br />mulander@bunkier_mysli:~/code/blog/lac$ gcc -std=gnu99 -o conftest -g -O2 -DHAVE_CONFIG_H -Wall -W test.c<br /><br />test.c: In function 'main':<br />test.c:6:3: warning: implicit declaration of function 'fallocate'<br />mulander@bunkier_mysli:~/code/blog/lac$ ./conftest<br />mulander@bunkier_mysli:~/code/blog/lac$ echo $?<br />0<br /></code><br /><br />The echo $? command shows the return code of the last run program. In our case it was 0 indicating that the program executed correctly. We did get a warning about implicitly declaring fallocate in this test but the result was not a failure. So what's different in rsync.h?<br /><br /><code> #if defined HAVE_FALLOCATE || HAVE_SYS_FALLOCATE<br />#include &lt;linux/falloc.h&gt;<br /></code><br /><code><br /></code><br /><div>Here we see that linux/falloc.h is included while in the test case we only had fcntl.h and sys/types.h. Adding #include &lt;linux/falloc.h&gt; to our test.c file will result in a fatal error on compilation (at least on my system) stating that such file or directory does not exist.<br /><br />I did find <a href="http://www.digipedia.pl/man/doc/view/fallocate.2/">a man page</a> on the web for fallocate(2) and it states that linux/falloc.h is in fact the correct header to include. The only thing left to do is to check our local system man pages. Use the command man 2 fallocate.<br /><br /><code><br />SYNOPSIS<br />&nbsp; &nbsp; &nbsp; &nbsp;#define _GNU_SOURCE &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; /* See feature_test_macros(7) */<br />&nbsp; &nbsp; &nbsp; &nbsp;#include &lt;fcntl.h&gt;<br /><br />&nbsp; &nbsp; &nbsp; &nbsp;int fallocate(int fd, int mode, off_t offset, off_t len);<br /></code></div></div></div><br />The synopsis section of the man page confirms that in case of our system - fnctl.h is the place where the fallocate function lives. Also adding the #define _GNU_SOURCE line to our test.c file squelches the warning about implicit fallocate declaration so we can confirm that this approach is correct in our case.<br /><br />That particular change to rsync.h was made on 2011-04-05 - not that long ago. We can even <a href="http://gitweb.samba.org/?p=rsync.git;a=commitdiff;h=28b519c93b6db30b6520d46f8cd65160213fddd2">browse the changes online</a>. Since at this point we are not sure how to correctly handle this problem, we checked the official bug tracker and asked around on the unofficial irc channel. Gaining no information about this problem being known - we reported it to the official mailing list in the hope that a maintainer will resolve it appropriately. You can view <a href="http://lists.samba.org/archive/rsync/2011-May/026324.html">our report here</a>. As a workaround for now, we will remove the include and replace it with #include &lt;fcntl.h&gt; without adding the define for _GNU_SOURCE constant because it's already present in config.h.<br /><br />Running make again with our change passed the compilation step without any reported problems. Since we passed the build and rsync --version didn't crash in a horrible way we've sent <a href="http://lists.samba.org/archive/rsync/2011-May/026325.html">our patch</a> to the mailing list.<br /><br /><code><br />mulander@bunkier_mysli:~/code/blog/lac/rsync$ ./rsync --version<br />rsync &nbsp;version 3.1.0dev &nbsp;protocol version 31.PR13<br />Copyright (C) 1996-2011 by Andrew Tridgell, Wayne Davison, and others.<br />Web site: http://rsync.samba.org/<br />Capabilities:<br />&nbsp; &nbsp; 64-bit files, 64-bit inums, 32-bit timestamps, 64-bit long ints,<br />&nbsp; &nbsp; socketpairs, hardlinks, symlinks, IPv6, batchfiles, inplace,<br />&nbsp; &nbsp; append, ACLs, xattrs, iconv, symtimes, prealloc<br /><br />rsync comes with ABSOLUTELY NO WARRANTY. &nbsp;This is free software, and you<br />are welcome to redistribute it under certain conditions. &nbsp;See the GNU<br />General Public Licence for details.<br /></code><br /><div><br /></div><div>At this point, we have a locally built copy of rsync which we will use from now on for our further exploration of rsync. Stay tuned ;)</div>