---
layout: post
title: The Go language year and a half later
date: '2011-04-18T12:51:00.000-07:00'
author: Adam Wo≈Çk
tags:
- go
- programming
modified_time: '2011-04-19T04:37:28.966-07:00'
blogger_id: tag:blogger.com,1999:blog-7611594305180455830.post-7376983422466682214
blogger_orig_url: http://homing-on-code.blogspot.com/2011/04/go-language-year-and-half-later_18.html
---

<div class="separator" style="clear: both; text-align: center;"><a href="http://gynvael.coldwind.pl/img/rt_in_go.png" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" height="240" src="http://gynvael.coldwind.pl/img/rt_in_go.png" width="320" /></a></div><span class="Apple-style-span" style="font-family: inherit;"><span class="Apple-style-span" style="line-height: 21px;">[<i>This note was originally written and published as a guest post on my <a href="http://gynvael.coldwind.pl/?lang=en">friends blog</a>. I highly recommend a visit.</i>]</span></span><br /><span class="Apple-style-span" style="font-family: inherit;"><span class="Apple-style-span" style="line-height: 21px;">On December 12 2009 Gynvael wrote a blog post about his first impressions of Google's Go language. Over an year later I mentioned to the author that a similar post about <a href="http://www.digitalmars.com/d/">Digital Mars D</a> and <a href="https://github.com/graydon/rust/wiki/">Mozilla Rust</a> would also be an interesting topic. This whole conversation reminded me about the original post and influenced to refresh the <a href="http://gynvael.coldwind.pl/?id=249">material</a>. After encountering the following sentance </span><span class="Apple-style-span" style="line-height: 21px;"><cite>"And, I look forward to the Windows version, since it's currently available only on *nix platforms."&nbsp;</cite></span><span class="Apple-style-span" style="line-height: 21px;">I decided to learn about the current state of Go.</span></span><br /><span class="Apple-style-span" style="font-family: inherit;"><span class="Apple-style-span" style="line-height: 21px;"></span></span><br /><a name='more'></a><span class="Apple-style-span" style="font-family: inherit;"><span class="Apple-style-span" style="line-height: 21px;"><br /></span></span><br /><span class="Apple-style-span" style="line-height: 21px;">Couple of minutes spent on the <a href="http://golang.org/">official Go website</a>&nbsp;quickly exposed the <a href="http://code.google.com/p/go/wiki/WindowsPort">link</a>&nbsp;discussing a port of the language for the MS Windows platform.&nbsp;</span><br /><span class="Apple-style-span" style="line-height: 21px;"><br /></span><br /><span class="Apple-style-span" style="line-height: 21px;">The port page <a href="http://code.google.com/p/gomingw/downloads/list">links</a> directly to a site hosting compiled releases of the language from which we download the gowin32_2011-03-07.1_installer.exe and use it to install Go on our system.</span><br /><span class="Apple-style-span" style="line-height: 21px;"><br /></span><br /><span class="Apple-style-span" style="line-height: 21px;">During the reconnaissance Gynvael ported one of his raytracers to the language. My goal was to compile and run his code with a positive result on the MS Windows platform with eventual updates to the source in order to obtain a result compatible with his initial implementation.</span><br /><span class="Apple-style-span" style="line-height: 21px;"><br /></span><br /><span class="Apple-style-span"><code style="line-height: 21px;"><a href="http://gynvael.coldwind.pl/download.php?f=t2.go">t2.go</a></code><span class="Apple-style-span" style="line-height: 21px;">&nbsp;starts with a series of preprocessor macro declarations. I checked if a similar feature was recently added to the language but a quick glimpse over their mailing list and&nbsp;bug tracker exposed that this&nbsp;functionality&nbsp;is still intentionally avoided.</span></span><br /><span class="Apple-style-span"><span class="Apple-style-span" style="line-height: 21px;">This state forces us to process the file with the standard <code>cpp</code> preprocessor according to the authors recommendations and removing the macro definitions with the help of <code>grep</code>. For this purpose we will use a separate MinGW installation already present on my system.</span></span><br /><span class="Apple-style-span"><span class="Apple-style-span" style="line-height: 21px;"><br /></span></span><br /><span class="Apple-style-span"><span class="Apple-style-span" style="line-height: 21px;">Execute the following command in a MinGW shell:</span></span><br /><span class="Apple-style-span" style="line-height: 16px;"><span class="Apple-style-span" style="font-family: inherit;"><code>$ cpp t2.go | grep -v '^#' &gt; t2.out.go</code></span></span><br /><span class="Apple-style-span" style="font-family: monospace;"><span class="Apple-style-span" style="line-height: 16px;"><br /></span></span><br /><span class="Apple-style-span" style="line-height: 16px;"><span class="Apple-style-span" style="font-family: inherit;">In the following sections of this post I will assume that at this point the </span><code style="font-family: monospace;">t2.out.go</code><span class="Apple-style-span" style="font-family: inherit;"> file was renamed to</span> <code style="font-family: monospace;">t2.go</code><span class="Apple-style-span" style="font-family: inherit;">.</span></span><br /><span class="Apple-style-span" style="line-height: 16px;"><br /></span><br /><span class="Apple-style-span" style="line-height: 16px;">Now from a regular <code>cmd.exe</code> command line we try to execute the next step outlined in the program header:</span><br /><span class="Apple-style-span" style="line-height: 16px;"><br /></span><br /><span class="Apple-style-span" style="line-height: 16px;"><span class="Apple-style-span" style="font-family: inherit;"><code>C:\blog&gt;6g t2.go</code></span></span><br /><code><span class="Apple-style-span" style="line-height: 16px;"><span class="Apple-style-span" style="font-family: inherit;">The name '6g' is not recognized as an internal or external command, operable program or batch file.</span></span></code><br /><span class="Apple-style-span" style="line-height: 16px;"><span class="Apple-style-span" style="font-family: inherit;"><br /></span></span><br /><span class="Apple-style-span" style="line-height: 16px;"><span class="Apple-style-span" style="font-family: inherit;">Nothing unusual.</span></span><br /><span class="Apple-style-span" style="line-height: 16px;">We've downloaded the 32-bit version of Go (I didn't see other versions on the <a href="http://code.google.com/p/gomingw/downloads/">download page</a>). </span><br /><span class="Apple-style-span" style="line-height: 16px;">The language creators were following a <a href="http://plan9.bell-labs.com/sys/doc/compiler.html">specific naming scheme</a> from the plan9 operating system, so <code>6</code> in <code>6g</code> stands for <code>amd64</code> (<code>x86-64</code>) and <code>g</code> indicates that it is a Go language compiler.</span><br /><span class="Apple-style-span" style="line-height: 16px;">In this case we need to use the <code>8g</code> compiler and the <code>8l</code> linker (where <code>8</code> stands for the <code>x86</code> architecture).</span><br /><span class="Apple-style-span" style="line-height: 16px;"><br /></span><br /><span class="Apple-style-span" style="line-height: 16px;">Let's retry the compilation with the proper programs:</span><br /><span class="Apple-style-span" style="line-height: 16px;"><span class="Apple-style-span" style="font-family: inherit;"><code>C:\blog&gt;8g t2.go<br />t2.go:57: syntax error: unexpected semicolon or newline before {<br />t2.go:60: non-declaration statement outside function body<br />t2.go:62: non-declaration statement outside function body<br />t2.go:65: syntax error: unexpected semicolon or newline before {<br />t2.go:65: non-declaration statement outside function body<br />t2.go:66: non-declaration statement outside function body<br />t2.go:67: non-declaration statement outside function body<br />t2.go:68: non-declaration statement outside function body<br />t2.go:70: syntax error: unexpected semicolon or newline before {<br />t2.go:70: too many errors</code></span></span><br /><span class="Apple-style-span" style="line-height: 16px;"><span class="Apple-style-span" style="font-family: inherit;"><br /></span></span><br /><span class="Apple-style-span" style="line-height: 16px;"><span class="Apple-style-span" style="font-family: inherit;">The compilation problems listed above are a result from the changes in the language itself during one year of it's development.</span></span><br /><span class="Apple-style-span" style="line-height: 16px;"><span class="Apple-style-span" style="font-family: inherit;">It's worth to note the error <code>t2.go:70: too many errors</code> doesn't mean that we made a tremendous amount of mistakes in line 70 :) The compiler is informing us, that the amount of errors is larger than displayed so the output of following problems is suspended until the currently presented ones are fixed.</span></span><br /><span class="Apple-style-span" style="line-height: 16px;"><span class="Apple-style-span" style="font-family: inherit;">Most people experienced in software development know that fixing the first reported error often eliminates a large part of the listed problems or <i>reveals</i> their real cause.</span></span><br /><span class="Apple-style-span" style="line-height: 16px;"><span class="Apple-style-span" style="font-family: inherit;">Spitting out each error on the output often leads to a mistake most beginner programmers make - fixing the last visible problem. The default behavior of the Go compiler will reduce the amount of people <i>Chasing the Wind</i>. Let's observe this on the first set of errors:</span></span><br /><span class="Apple-style-span" style="line-height: 16px;"><span class="Apple-style-span" style="font-family: inherit;"><br /></span></span><br /><code>t2.go:57: syntax error: unexpected semicolon or newline before {<br />t2.go:60: non-declaration statement outside function body<br />t2.go:62: non-declaration statement outside function body</code><br /><code><br /></code><br />The contents of lines 56, 57 and 58 is presented below:<br /><code><span class="Apple-style-span" style="line-height: 16px;"><span class="Apple-style-span" style="font-family: inherit;">56: func main()<br />57: {<br />58: &nbsp; fmt.Printf("Simple RT by gynvael.coldwind//vx (http://gynvael.coldwind.pl)\n");</span></span></code><br /><code><span class="Apple-style-span" style="line-height: 16px;"><span class="Apple-style-span" style="font-family: inherit;"><br /></span></span></code><br /><span class="Apple-style-span" style="font-family: inherit; line-height: 16px;">The compiler complains about an unexpected semicolon or newline before the opening brace token. Referring to the <a href="http://golang.org/doc/effective_go.html#semicolons">documentation</a> we read:</span><br /><code><span class="Apple-style-span" style="line-height: 16px;"><span class="Apple-style-span" style="font-family: inherit;"><br /></span></span></code><br /><span class="Apple-style-span" style="line-height: 21px;"><span class="Apple-style-span" style="font-family: inherit;"><cite>One caveat. You should never put the opening brace of a control structure (if, for, switch, or select) on the next line. If you do, a semicolon will be inserted before the brace, which could cause unwanted effects. Write them like this:</cite></span></span><br /><code>if i &lt; f() {<br />&nbsp; &nbsp;g()<br />}</code><br /><cite>not like this</cite><br /><code>if i &lt; f()  // wrong!<br />{ &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// wrong!<br />&nbsp; &nbsp;g()<br />}</code><br /><br /><span class="Apple-style-span" style="font-family: inherit;">This sounds like a similar problem to the one we encountered but there is no mention of an automatically inserted semicolon after a function declaration. In order to precisely determine the root cause of our problem we look up the <a href="http://golang.org/doc/devel/release.html">documented</a> changes between the language releases.</span><br /><span class="Apple-style-span" style="font-family: inherit;"><br /></span><br /><span class="Apple-style-span" style="font-family: inherit;">In the note from 2009-12-22 we read:</span><br /><span class="Apple-style-span" style="font-family: inherit;"><br /></span><br /><cite>Since the last release there has been one large syntactic change to<br />the language, already discussed extensively on this list: semicolons<br />are now implied between statement-ending tokens and newline characters.</cite><br /><br />A broader discussion on the introduced changes regarding the rules of insertion for the semicolon can be <a href="http://groups.google.com/group/golang-nuts/browse_thread/thread/5ee32b588d10f2e9">found</a> on the mailing list.<br /><br />Below an interesting excerpt from the discussion with an additional justification of the changes:<br /><br /><cite>Believe it or not, this removes rules.  Robert played with <br />this in the parser and the language spec and was surprised <br />how much simpler things got.  I am doing the same conversion <br />in the 6g compiler right now, and the dead code I'm cutting <br />away is one of the ugliest parts of the compiler.  I'd <br />forgotten writing it, but boy is it ugly.  And soon it will <br />be gone. -- Russ Cox<br /></cite><br /><br />It's interesting that there is no mention of influence in the case of function headers. One can even find examples on the mailing list thread, that use the exact same brace placement as Gynvael did, which could lead to assumptions that it's still a valid syntax.<br />In our case. The most interesting information is a mention of a feature&nbsp;built-into <code>gofmt</code>, which allows automatic adjustments of code using the old syntax rules.<br /><code>gofmt -oldparser -w *.go</code><br />Let's try to manually fix the error on line 57 before we try any automatic transformations on our code.<br /><code>56: func main() {<br />57:   fmt.Printf("Simple RT by gynvael.coldwind//vx (http://gynvael.coldwind.pl)\n");</code><br /><br /><code>C:\blog&gt;8g t2.go<br />t2.go:94: syntax error: unexpected semicolon or newline before {<br />t2.go:97: syntax error: unexpected {<br />t2.go:114: syntax error: unexpected }<br />t2.go:116: non-declaration statement outside function body<br />t2.go:116: empty top-level declaration<br />t2.go:117: non-declaration statement outside function body<br />t2.go:117: too many errors</code><br /><br />The previous listing went up to the error on line 70, including an identical message on line 65 which doesn't contain any errors. After the change the list starts on line 94, saving us the effort of going through a lot of code in the search of nonexistent errors. The list would be a lot larger, if the Go compiler didn't stop reporting the errors.<br /><br />Now we will rollback our change to the line 57 and see how many problems <code>gofmt</code> will fix:<br /><code>C:\blog&gt;gofmt -oldparser -w t2.go<br />flag provided but not defined: -oldparser<br />usage: gofmt [flags] [path ...]<br />-tabwidth=8: tab width<br />-trace=false: print parse trace<br />-r="": rewrite rule (e.g., '+-[+-:len(+-)] -&gt; +-[+-:]')<br />-tabindent=true: indent with tabs independent of -spaces<br />-s=false: simplify code<br />-l=false: list files whose formatting differs from gofmt's<br />-w=false: write result to (source) file instead of stdout<br />-ast=false: print AST (before rewrites)<br />-spaces=true: align with spaces instead of tabs<br />-comments=true: print comments<br /></code><br />The above error <cite>flag provided but not defined: -oldparser</cite>. Indicates no support for the flag <code>-oldparser</code> we found mentioned in the release notes.<br />In the note from 2010-01-13 we see an update announcing the removal of the <code>-oldprinter</code> flag, obviously this isn't the flag we are using.<br />In the whole document there is only one occurrence of the <code>oldparser</code> string. At this point we must assume that the removal of this flag was left undocumented. The only thing left we can do is to try calling the tool without providing the flag hoping that the behavior is on by default:<br /><code><br />C:\blog&gt;gofmt -w t2.go<br />t2.go:57:1: expected declaration, found '{'<br />..... a long list of recognized problems<br /></code><br /><br />It seems that we're out of luck.<code>gofmt</code> doesn't fix any of our errors by default.<br />We will not report the problem to the authors. Most probably we would be directed to an older release of the tool or were suggested to modify our&nbsp;code base&nbsp;with a custom script/manually (based on how <a href="http://code.google.com/p/go/issues/detail?id=453">this issue</a> was handled in December 2009).<br />All that's left is just fixing the opening braces after function declarations and those reported along other instruction (for example the <code>if</code> statement).<br />I'm leaving this as an&nbsp;exercise&nbsp;for the reader (and a <a href="http://dl.dropbox.com/u/9472/gyn-t2/blog/t2p1.patch">link to a patch</a> for the lazy ones).<br /><br />After fixing the last brace problem, the compiler will print out another interesting set of errors:<br /><code>C:\blog&gt;8g t2.go<br />t2.go:56: ".ggg....." not used<br />t2.go:56: ".g...rrr." not used<br />t2.go:56: ".g.g.r.r." not used<br />t2.go:56: ".ggg.rrr." not used<br />t2.go:56: "........." not used<br />t2.go:411: ".ggg....." not used<br />t2.go:411: ".g...rrr." not used<br />t2.go:411: ".g.g.r.r." not used<br />t2.go:411: ".ggg.rrr." not used<br />t2.go:411: "........." not used<br />t2.go:56: too many errors</code><br /><br />The messages indicate that strings located on lines 56 and 411 are not used. The reported lines point to the beginning and end of the <code>main</code> function, so they are not helpful in locating the erroneous line. Lucky for us, there aren't many occurrences of the content of the reported strings, a quick manual search points us to line 81:<br /><br /><code>81: SpherePosMap =<br />82: "........."<br />83: ".ggg....."<br />84: ".g...rrr."<br />85: ".g.g.r.r."<br />86: ".ggg.rrr."<br />87: ".........";<br /></code><br /><br />In the light of the previous information we have gathered, we can assume that the cause of this problem is yet again the automatic insertion of the semicolon.<br />Here is the base for my reasoning:<br />If a semicolon is inserted in line 82 then the string containing only periods will be stored in the variable <code>SpherePosMap</code>.<br />On the next step, the compiler will insert semicolons at the end of each following lines containing string literals which aren't assigned to variable hence not stored anywhere - unused.<br />The compiler reports the first unused string as the one containing <code>".ggg....."</code>, so the first line is completely omitted from the output which we assumed is stored in the <code>SpherePosMap</code> variable. This behavior is plausible enough that we can try a modification based on concatenating the strings togheter (using the <code>+</code> operator).<br /><br /><code>81: SpherePosMap =<br />82: "........." +<br />83: ".ggg....." +<br />84: ".g...rrr." +<br />85: ".g.g.r.r." +<br />86: ".ggg.rrr." +<br />87: ".........";<br /></code><br /><br />Recompilation confirms that the problem is resolved and we are presented with a new one:<br /><code>C:\blog&gt;8g t2.go<br />t2.go:348: img.Width undefined (type *image.RGBA has no field or method Width)<br />t2.go:349: img.Height undefined (type *image.RGBA has no field or method Height)<br /><br />t2.go:357: img.Height undefined (type *image.RGBA has no field or method Height)<br /><br />t2.go:360: img.Width undefined (type *image.RGBA has no field or method Width)<br />t2.go:400: img.Pixel undefined (type *image.RGBA has no field or method Pixel)</code><br /><br />It looks like the interface of the <code>image</code> package changed.<br />A release note from 2010-08-11 confirms this with a following description of changes to the package:<br /><br /><cite>An image.Image now has a Bounds rectangle, where previously it ranged<br />from (0, 0) to (Width, Height). Loops that previously looked like:</cite><br /><span class="Apple-style-span" style="font-family: monospace;"></span><br /><span class="Apple-style-span" style="font-family: monospace;">for y := 0; y &lt; img.Height(); y++ {</span><br /><span class="Apple-style-span" style="font-family: monospace;">&nbsp; &nbsp;for x := 0; x &lt; img.Width(); x++ {</span><br /><span class="Apple-style-span" style="font-family: monospace;">&nbsp; &nbsp; &nbsp; &nbsp;// Do something with img.At(x, y)</span><br /><span class="Apple-style-span" style="font-family: monospace;">&nbsp; &nbsp;}</span><br /><span class="Apple-style-span" style="font-family: monospace;">}</span><br /><br /><cite>should instead be:</cite><br /><span class="Apple-style-span" style="font-family: monospace;"></span><br /><span class="Apple-style-span" style="font-family: monospace;">b := img.Bounds()</span><br /><span class="Apple-style-span" style="font-family: monospace;">for y := b.Min.Y; y &lt; b.Max.Y; y++ {</span><br /><span class="Apple-style-span" style="font-family: monospace;">&nbsp; &nbsp;for x := b.Min.X; x &lt; b.Max.X; x++ {</span><br /><span class="Apple-style-span" style="font-family: monospace;">&nbsp; &nbsp; &nbsp; &nbsp;// Do something with img.At(x, y)</span><br /><span class="Apple-style-span" style="font-family: monospace;">&nbsp; &nbsp;}</span><br /><span class="Apple-style-span" style="font-family: monospace;">}</span><br /><br /><cite>* image: change image representation from slice-of-slices to linear buffer,<br />introduce Decode and RegisterFormat,<br />introduce Transparent and Opaque,<br />replace Width and Height by Bounds, add the Point and Rect types.</cite><br /><br />The described changes enforce specific modifications of the <code>Render</code> function in the lines reported by the compiler. We start by adding the <code>b</code> variable to the list of declared variables in the function in order to avoid repetitive calls to <code>img.Bounds.Max/Min.X/Y</code> directy in the code:<br /><br /><code>var b = img.Bounds();</code><br /><br />We also substitute occurrences of <code>img.Width()</code> and <code>img.Height()</code> to:<br /><br /><code>b.Max.X // instead of img.Width()<br />b.Max.Y // instead of img.Height()<br /></code><br />Additionally in line 361 a purely <i>cosmetic</i> change from:<br /><br /><code>x = 0</code><br /><br />to:<br /><br /><code>x = b.Min.X</code><br /><br />After finishing the listed changes we are left with only one problem:<br /><br /><code>t2.go:400: img.Pixel undefined (type *image.RGBA has no field or method Pixel)</code><br /><br />A mention of a change to <code>Pixel</code> appears in the first sentence of the second part of changes to the image package:<br /><cite><br /></cite><br /><cite>* image: change image representation from slice-of-slices to linear buffer</cite><br /><br />Unfortunately, in the case of this change the authors didn't provide examples of modifications that are required on the code base. We locate the <code>image.go</code> package on our hardware which was installed along our compiler and check the section responsible for handling the <code>image.RGBA</code> structure.<br /><code><br /></code><br /><code></code><br /><code>/* Location: C:\Go\src\pkg\image\image.go:28 */</code><br /><code>// An RGBA is an in-memory image of RGBAColor values.</code><br /><code>type RGBA struct {</code><br /><code>&nbsp; &nbsp;// Pix holds the image's pixels. The pixel at (x, y) is Pix[y*Stride+x].</code><br /><code>&nbsp; &nbsp;Pix &nbsp; &nbsp;[]RGBAColor</code><br /><code>&nbsp; &nbsp;Stride int</code><br /><code>&nbsp; &nbsp;// Rect is the image's bounds.</code><br /><code>&nbsp; &nbsp;Rect Rectangle</code><br /><code>}</code><br /><code> </code><br /><br />By reviewing the provided snippet we can deduce, that the name of the <code>Pixel</code> field was changed to <code>Pix</code> and according to the release note description it's representation is changed from a slice-of-slices (a multidimensional array?) to a linear buffer.<br />A comment placed inside the structure declaration contains an example usage of the new format:<br /><code><br /></code><br /><code>Pix[y*Stride+x]</code><br /><br />Armed with new information we go back to our code base and introduce the following change in line 401 from:<br /><code><br /></code><br /><code>img.Pixel[y][x] = cl;</code><br /><br />to:<br /><code><br /></code><br /><code>img.Pix[y*img.Stride+x] = cl;</code><br /><br />Once again we attempt a compilation of the code:<br /><code><br /></code><br /><code>C:\blog&gt;8g t2.go</code><br /><br />This time without errors, so we move onward to the linking:<br /><code><br /></code><br /><code>C:\blog&gt;8l t2.8</code><br /><br />The effect of the above commands is an executable <code>8.out.exe</code>, which we gladly run :)<br /><code><br /></code><br /><code>C:\blog&gt;8.out.exe<br />Simple RT by gynvael.coldwind//vx (http://gynvael.coldwind.pl)<br />Creating scene...<br />Rendering...<br />[0] Thread start<br />[1] Thread start<br />[2] Thread start<br />[3] Thread start<br />[0] Thread finished<br />[1] Thread finished<br />[2] Thread finished<br />[3] Thread finished<br />Writing test.png image...<br />Done.</code><br /><br />The output of the program in png format can be <a href="http://dl.dropbox.com/u/9472/gyn-t2/blog/test1.png">viewed here</a>.<br />During the programs execution we can observe, that only one of the two (in my case) available CPU cores is utilized.<br /><br />The code after every <b>necessary</b> change required to compile and run it can be found <a href="http://dl.dropbox.com/u/9472/gyn-t2/blog/t2_p1.go">here</a>.<br /><br />At this point, we can think how to make the program correctly take advantage of the available cores. The <a href="http://golang.org/doc/effective_go.html?h=6g#concurrency">official documentation</a> (section Concurrency-&gt;Parallelization) proves to be helpful again.<br /><cite>The current implementation of gc (6g, etc.) will not parallelize this code by default.</cite><br /><br />Examples on the page show how to achieve parallelization and information that the feature is planned to be made automatic in the <i>future</i>.<br /><br />Let's try to modify Gynvael's code again.<br />We will add an <code>runtime</code> package import to the beginning of the file and define a constant containing the number of CPU cores available in our machine:<br /><code><br /></code><br /><code>import (<br />"os";<br />"fmt";<br />"math";<br />"image";<br />"runtime"; // Added for rendering parallelization<br />"image/png"<br />)<br />const NCPU = 2; // Number of cores</code><br /><br />Next, at the beginning of the <code>main()</code> function we add a call to <code>GOMAXPROCS</code> passing the our constant as an input parameter:<br /><code><br /></code><br /><code>func main() {<br />runtime.GOMAXPROCS(NCPU)<br />fmt.Printf("Simple RT by gynvael.coldwind//vx (http://gynvael.coldwind.pl)\n");</code><br /><br />After recompiling the program and doing an additional run we can observe that both cores are properly used. We gain about 4 seconds by using the second CPU (~20s instead of ~24s to render the graphic).<br />It's interesting, that in the initial version, according to the trace printouts, the threads finished their works always in the same order - the new version shows much more diversity here.<br />The rendered file <code>test.png</code> is identical to the rendering from our previous pass (<code>diff</code> doesn't report any differences).<br /><br />The modified code can be found <a href="http://dl.dropbox.com/u/9472/gyn-t2/blog/t2_p2.go">here</a>.<br /><br />It's worth to note, that the same effect can be achieved by setting the environment variable <code>GOMAXPROCS</code>. However this isn't the most convenient way on the MS Windows platform hence we decided to modify the code.<br /><br />At this point we could finish our fun with the code but let's reformat the code with <code>gofmt</code> as a final step:<br /><code><br /></code><br /><code>C:\blog&gt;gofmt t2.go &gt; t2_p3.go</code><br /><br />Output from <code>diff -u</code> shows changes in indention of several sections of the code, removal of all the semicolons (which became optional during the development of the language) and brace placement around local code blocks.<br />The code exapnded to 627 lines from 416 which we had after our last modification. In my opinion greatly gaining on readability.<br /><br />This step should also help with future changes to the code base required due to potential changes to the languages syntax (if done often enough - before the migration phase is removed from <code>gofmt</code> similarly to the case of <code>-oldparser</code>).<br /><br />A final version of the  code after all of the modifications can be found under <a href="http://dl.dropbox.com/u/9472/gyn-t2/blog/t2_p3.go">this address</a>.<br /><br />I also provided links to the executable files compiled on my system (MS Windows Vista 32-bit):<br /><br /><ul><li><a href="http://dl.dropbox.com/u/9472/gyn-t2/blog/t2p1.exe">t2p1.exe</a> (single core version)</li><li><a href="http://dl.dropbox.com/u/9472/gyn-t2/blog/t2p2.exe">t2p2.exe</a> (dual core version)</li><li><a href="http://dl.dropbox.com/u/9472/gyn-t2/blog/t2p3.exe">t2p3.exe</a> (dual core version after reformatting with <code>gofmt</code></li></ul><br />Regardless of the lack of recent updates to the code base and a language still in development, the amount and difficulty of required changes to the code were surprisingly small.<br />The quality of the error reports generated by the Go compiler is also satisfying  - Mostly pointing to the precise source of the problem without flooding with irrelevant information.<br />The <a href="http://blog.golang.org/2011/03/go-becomes-more-stable.html">recently published</a> post on the official blog of the language informs that the language is entering a more stabilized phase with official releases published once a month (up to now they were published once a week). The <i>weekly</i> releases will also remain their publication schedule which is a nice message to people wanting to experiment with the bleeding edge version of the language. The authors also announced the introduction of the <code>gofix</code> tool, which will become responsible for modifications of the code required by changes to the language, so most of our actions described in this post should become redundant in the future :)<br /><br /><b>PS.</b><br />While writing this note I stumbled upon on a different implementation of the Go language compiler for the MS Windows platform, namely <a href="http://www.newquistsolutions.com/ergo">erGo</a>, which is especially interesting since it's implemented in Go itself and supports debugging in Visual Studio 2008. Unfortunately I didn't had the opportunity to test this implementation.<br /><br /><b>PS2.</b><br />Thanks neme for proof reading this post :)<br /><br /><b>PS3.</b><br />When this note was initially written <code>gofix</code> wasn't released yet. It's out now so go ahead and read <a href="http://blog.golang.org/2011/04/introducing-gofix.html">about it</a> on the official blog. If anyone tries the tool on the initial version of Gynvael's code then please share with us in the comments :)