---
layout: post
title: Rolling with snapshots
date: '2015-02-01T11:55:00.000-08:00'
author: Adam Wo≈Çk
tags:
- openbsd
modified_time: '2015-02-01T12:32:56.201-08:00'
thumbnail: http://2.bp.blogspot.com/-lAFnvCgnhDY/VM5xH_hwB1I/AAAAAAAAEYY/9BU5VN29GWs/s72-c/2015-02-01%2B19.27.18.jpg
blogger_id: tag:blogger.com,1999:blog-7611594305180455830.post-5444588398864442619
blogger_orig_url: http://homing-on-code.blogspot.com/2015/02/rolling-with-snapshots.html
---

<a href="http://2.bp.blogspot.com/-lAFnvCgnhDY/VM5xH_hwB1I/AAAAAAAAEYY/9BU5VN29GWs/s1600/2015-02-01%2B19.27.18.jpg" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="http://2.bp.blogspot.com/-lAFnvCgnhDY/VM5xH_hwB1I/AAAAAAAAEYY/9BU5VN29GWs/s1600/2015-02-01%2B19.27.18.jpg" height="320" width="240" /></a>is not as scary as most people think. From the outside the OpenBSD upgrade process, especially when following bleeding edge development looks really intensive and risky. Here's how I feel about it after regular weekly snapshot upgrades for the past 7 weeks.<br /><br /><a name='more'></a><br />When I first started with OpenBSD I was advised to remain on the release and follow <a href="http://www.openbsd.org/errata56.html">errata</a> patches. Even though now I'm rolling with snapshots I still don't regret that and would advise anyone to start from there. The biggest gain I had from doing basic errata patches is knowledge on how the system is built - even on a really basic level this process removes a lot of unknowns that most package managers hide from people. Grab the source, apply the patch and follow the outlined steps to build the change and restart the system or just the required services. If my main goal was running OpenBSD as a server or a router that I don't intend to touch for the next 6 months it would still be the path that I would follow.<br /><br />Since I'm running on a laptop and want to get involved with at least porting some software. I had to bump up my version to CURRENT or at least a recent snapshot. I come from a Linux background and that thought was a bit terrifying at first. I can handle the upgrade steps required by Arch Linux on some big infrastructure changes but I didn't feel that comfortable to run a bleeding edge version of an OS that I'm just beginning to learn. Especially since the process doesn't boil down to running a single command like in most Linux distributions. Well at least it looked like that from the outside.<br /><br />What pushed me over the bump was two things. Great documentation of the process in the <a href="http://www.openbsd.org/faq//faq5.html">official OpenBSD documentation</a> &amp; a nice and calm explanation of it in the <a href="https://www.michaelwlucas.com/nonfiction/absolute-openbsd-2nd-edition">Absolute OpenBSD</a> book. I spent the first two days reading the official documentation then did a full backup of the stuff I care about and armed with the mentioned book started the upgrade process anticipating everything going haywire. Twenty minutes later I was staring at a fully functional OpenBSD desktop from a snapshot built a day before. Fifteen minutes of that time can be accounted to me reading the related chapter in the Absolute OpenBSD book &amp; staring at progress bars of packages being downloaded.<br /><br />So how does the process actually look? First of all, this post again is not a tutorial. When in doubt please refer to the excellent documentation from the project as things greatly depend on current development efforts in the project. I will just outline the basic steps I do once a week to show you that the whole thing is not as scary as it seems.<br /><br />When time arrives (mostly on weekends in my case) I check my <a href="http://piotrkosoft.net/pub/OpenBSD/snapshots/i386/">mirror of choice</a> for any new snapshots. I mostly just look at the timestamps of the bsd.rd file which is the installation kernel for OpenBSD. I have a pretty good idea of what went on between my last snapshot and the current one since I'm following the mailing lists (cvs commits, tech &amp; misc) but before I even download the bsd.rd file I check the <a href="http://www.openbsd.org/faq/current.html">following current FAQ</a>. Once I'm sure that I'm OK with any additionally required steps I proceed to grab the file.<br /><br />The bsd.rd file is supposed to be dropped in your system root directory (/). Before doing that I make a backup copy of all the old kernels (bsd, bsd.sp &amp; bsd.rd). Mostly I just make a copy with the same name suffixed with .b that way if my upgrade goes wrong I can always attempt to boot up the old kernel with 'boot bsd.b'. I also keep a copy of the file in my home directory in order to remember which snapshots I used.<br /><br /><blockquote class="tr_bq">$ tree openbsd/snapshots/&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />openbsd/snapshots/<br />|-- 10-Dec-2014<br />|&nbsp;&nbsp; |-- base56.tgz<br />|&nbsp;&nbsp; |-- bsd<br />|&nbsp;&nbsp; |-- bsd.mp<br />|&nbsp;&nbsp; |-- bsd.rd<br />|&nbsp;&nbsp; `-- xbase56.tgz<br />|-- 10-Jan-2015<br />|&nbsp;&nbsp; `-- bsd.rd<br />|-- 22-Jan-2015<br />|&nbsp;&nbsp; `-- bsd.rd<br />|-- 23-Dec-2014<br />|&nbsp;&nbsp; `-- bsd.rd<br />|-- 24-Dec-2014<br />|&nbsp;&nbsp; `-- ports.tar.gz<br />|-- 27-Dec-2014<br />|&nbsp;&nbsp; |-- 29-Dec-2014.pkg<br />|&nbsp;&nbsp; `-- bsd.rd<br />|-- 30-Jan-2015<br />|&nbsp;&nbsp; `-- bsd.rd</blockquote><br />After that the only thing I need to do is reboot into the new kernel by entering <i>boot bsd.rd</i> in the boot prompt after a restart. This step triggers a regular OpenBSD installation with an 'Upgrade' option. The steps required are dead simple and mostly boil down to confirming the default choice the installer presents. The only thing I personally change is the mirror in case my current one starts having some issues.<br /><br />The upgrade takes literally minutes, in my case most of the time is spent on downloading base packages from the network. When it's done just reboot and log in into your upgraded system.<br /><br />The installer nicely reminds you to run <a href="http://www.openbsd.org/cgi-bin/man.cgi/OpenBSD-current/man8/sysmerge.8?query=sysmerge">sysmerge(8)</a> in order to upgrade any existing system wide configuration files. Between OpenBSD 5.6 &amp; 5.7 this step got a lot easier as you don't even have to specify file sets in the sysmerge command. I then perform any tasks mentioned in <a href="http://www.openbsd.org/faq/current.html">following current</a>.<br /><br />The last step of the upgrade is running <a href="http://www.openbsd.org/cgi-bin/man.cgi/OpenBSD-current/man1/pkg_add.1?query=pkg_add">pkg_add</a><a href="https://www.blogger.com/null"> -uiv</a> which upgrades any ports packages you installed. I was pleasantly surprised to see my otter port included in that process even though I only installed my personally built package but it got correctly picked up when the official one kicked in.<br /><br /><blockquote class="tr_bq">Update candidates: otter-browser-0.9.04 -&gt; otter-browser-0.9.04<br />Update candidates: qt5-5.3.2p7 -&gt; qt5-5.3.2p10<br />Update candidates: pulseaudio-5.0p2 -&gt; pulseaudio-5.0p2<br />otter-browser-0.9.04:pulseaudio-5.0p2-&gt;5.0p2: ok<br />otter-browser-0.9.04:qt5-5.3.2p7-&gt;5.3.2p10: ok<br />New package otter-browser-0.9.04 will run the following commands<br />+ @exec /usr/local/bin/update-desktop-database<br />+ @exec /usr/local/bin/gtk-update-icon-cache -q -t /usr/local/share/icons/hicolor<br />Running update<br />otter-browser-0.9.04-&gt;0.9.04: ok</blockquote>Finally the command will end and show any additional tasks you may need to perform.<br /><br /><blockquote class="tr_bq">Read shared items: ok<br />Look in /usr/local/share/doc/pkg-readmes for extra documentation.<br />--- -cyrus-sasl-2.1.26p12 -------------------<br />You should also run rm -rf /var/sasl2/*<br />--- -dconf-0.22.0p1 -------------------<br />You should also run rm -rf /etc/dconf/db/*<br />You should also run rm -rf /etc/dconf/profile/*<br />--- -iodbc-3.52.9p0 -------------------<br />You should also run rm -rf /etc/iodbc/ODBCDataSources/*<br />Couldn't find updates for quiterss-0.17.5<br />Extracted 1185387200 from 1756909918</blockquote>That's it. The whole process literally is bottle necked by your network connection. It's not any harder then upgrading your system on a typical Linux distribution. The process is just divided into more steps.<br /><br />On my first upgrade I was really pleasantly surprised that the OpenBSD project not only build snapshots but also packages that go along with it. This means that you obtain newer software packages without building them yourself (ie. Firefox).<br /><br />In the 7 upgrades I did, not even once OpenBSD failed to work. It does happen and I do expect to hit that at some point in time as I saw people reporting snapshot issues on the mailing lists. Though that's a good thing, narrowing down issues introduced in a specific snapshot is much easier then going through 6 months of code changes (and believe me OpenBSD is in <b>heavy</b> development - just look at the <a href="http://www.openbsd.org/56.html">5.6 release notes</a>). Additionally I love the fact that I can work on new ports, help people test their ports and even patches for developers since they now cleanly apply to my system.