---
layout: post
title: Puffy in the cloud
date: '2015-03-28T11:51:00.000-07:00'
author: Adam Wo≈Çk
tags:
- openbsd
modified_time: '2015-03-28T14:13:23.367-07:00'
thumbnail: http://2.bp.blogspot.com/-fMDd979Il9g/VRay1FCDNEI/AAAAAAAAEZI/XHA1cBCk1UU/s72-c/puffy-in-cloud.png
blogger_id: tag:blogger.com,1999:blog-7611594305180455830.post-6528977840567540897
blogger_orig_url: http://homing-on-code.blogspot.com/2015/03/puffy-in-cloud.html
---

<div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-fMDd979Il9g/VRay1FCDNEI/AAAAAAAAEZI/XHA1cBCk1UU/s1600/puffy-in-cloud.png" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="http://2.bp.blogspot.com/-fMDd979Il9g/VRay1FCDNEI/AAAAAAAAEZI/XHA1cBCk1UU/s1600/puffy-in-cloud.png" height="320" width="320" /></a></div>I finally found a nice <i>excuse</i> to run an OpenBSD server. My wife is a huge Dropbox user &amp; I'm not a fan of our photos sitting on their servers. Enough said, 640 GB of storage on <a href="https://www.vultr.com/">vultr.com</a> (plus having me of her head) finally convinced her that we should run our own :) In this post I'll go over the steps I took to configure a full blown <a href="https://owncloud.org/">ownCloud</a> server running on OpenBSD current with the new httpd.<br /><br /><br /><a name='more'></a><br /><br />It's worth to note that before even provisioning a server I did the full setup for the first time on my tiny i386 OpenBSD current box. This experience was invaluable, allowing me to test the whole setup in peace without Chinese automated hacking scripts hitting the server :)<br /><br />So what's the use case? Lots of storage and a fun box to play around for me. I saw vultr.com mentioned multiple times on the OpenBSD mailing lists and finally decided to give it a shot. The fact that vultr offers SATA storage plans sealed the deal.<br /><br />Ok. I'm crazy &amp; intend to run snapshots on the server. Why? First of all that's what I'm running on my daily box and the ability to test stuff out locally before going live into production is really great. Secondly I do trust the OpenBSD developers a lot, security issues in the base OS are far and between so the ports system is a bigger attack vector then the base OS even with a bigger window between updates. This server will run a lot of internet facing applications including the php ownCloud installation. I prefer to run the latest version from ports and to patch the base OS on a per-snapshot basis or just porting the most important fixes myself. Finally I do intend to play around with this box. Running the new httpd is a great way to contribute to the project by testing the software in a real life use case. It also means that I will be able to test amd64 patches instead of just working with a puny i386 machine.<br /><br />Enough said. Let's get down to business.<br /><br />Buying a server from vultr.com had some slight perturbations for me. They do a pre-check authorization against your card for $2,5 USD. My bank thought that the transaction might be fraudulent and decided to block my card until I clear the transaction with them. I must say that at first I expected a software glitch as I was expecting a $25 USD charge from them and fired a ticket on their support channel after a first talk with my bank. This doesn't sound like a great first impressions right? True. Though they quickly wiped away my doubts with their <b>amazing</b> support. I rarely had to wait more than five minutes for a systems administrator reply on the site. Rather quickly the whole issue was explained, my card was unblocked and I was free to provision a new server.<br /><br />Which I did. The SATA storage plans are available only in one zone but I'm not really worried about data locality. I won't go over the whole OpenBSD installation. That's both too simple &amp; much better covered in the official OpenBSD documentation. Though it's worth to note two specific things I encountered during the installation.<br /><br />The first one is my plan to partition the drive. I wanted 600 G for ownCloud storage and enough for other partitions that I don't feel limited while playing around with the system. Based on my experiences with the i386 installation I have on this box, some defaults felt too tight. I decided to bump those up to 4G. The vultr instance has 2 G of ram so I also decided to up the swap space to twice that size. You might notice a X11R6 partition there. No I will not be running X on that server but I did install the xenocara sets as a lot of ports tend to expect the X system being available even if it's not ever running. The most important parts of the partitioning plan is 600 G for /var as that's where postgres &amp; ownCloud will store it's data &amp; 10 G for the /home partition - that's my <i>have fun</i> sandbox.<br /><br />You can see my final layout on the screen-shot below.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-61HnFTdLr1I/VRa4HiI9g5I/AAAAAAAAEZY/eEE9xa5XTnY/s1600/2015-03-28-000636_712x235_scrot.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-61HnFTdLr1I/VRa4HiI9g5I/AAAAAAAAEZY/eEE9xa5XTnY/s1600/2015-03-28-000636_712x235_scrot.png" height="209" width="640" /></a></div><br />The second thing that's worth a mention is what happens after you <i>reboot</i> your fresh installation. Nothing special but I did spent some time debugging why the hell is my server booting again into the bsd.rd kernel, if you're in that position you have to go to your vultr.com management panel and remove the install.iso from your server. After that step your box will boot properly.<br /><br />Ok, so the box is up. You went through <a href="http://www.openbsd.org/cgi-bin/man.cgi/OpenBSD-current/man8/afterboot.8?query=afterboot"><i>man afterboot</i></a> as usual and configured your SSH keys. What's next? Possibly a lot of automated attempts to guess your SSH passwords from the Chinese IP address space.<br /><br />I hate my servers being hammered that way. In the past I usually set up a <a href="https://duckduckgo.com/l/?kh=-1&amp;uddg=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FFail2ban">fail2ban</a> script monitoring SSH login attempts. OpenBSD has a much better way of handling it though so you won't even have to play around with that software. The great folks at <a href="http://bsdnow.tv/">BSDNow.tv</a> provided an amazing <a href="http://www.bsdnow.tv/tutorials/pf">pf tutorial</a> which effectively blocks down those attempts. I highly recommend you go ahead, read &amp; implement it before going forward.<br /><br />Please remember one thing. This blog post is not a tutorial. This is a transcript of my experiences setting up the service at the time of this writing. OpenBSD ships with amazing documentation and you should use it. For our ownCloud instance we will need both PostgreSQL (my preference) and ownCloud itself. You should take the time to go through pkg-readmes shipped with those packages before doing anything to your system.<br /><ul><li>/usr/local/share/doc/pkg-readmes/owncloud-8.0.2</li><li>/usr/local/share/doc/pkg-readmes/postgresql-server-9.4.1p1 </li></ul>The new httpd web server in OpenBSD runs in a chroot (the previous ones were also patched by the development team to run in chroot). This has some implications. Our ownCloud instance will expect network connectivity and it won't have it without access to /etc/resolv.conf &amp; /etc/hosts. Additionally if we want to use UTF-8 locale then /usr/share/locale/UTF-8 should also be accessible to the httpd process. <br /><br />According to the above let us first create the font directory:<br /><blockquote class="tr_bq">mkdir -p /var/www/usr/share/locale/UTF-8/<br />cp /usr/share/locale/UTF-8/LC_CTYPE /var/www/usr/share/locale/UTF-8/ </blockquote>then a copy of our hosts &amp; resolv.conf files:<br /><blockquote class="tr_bq">mkdir -p /var/www/etc<br />cp /etc/hosts /var/www/etc/hosts<br />cp /etc/resolv.conf /var/www/etc/resolv.conf</blockquote>We also want to serve our cloud through https only. For this reason we will generate a self signed certificate using <a href="http://www.libressl.org/">LibreSSL</a>. You can of course use a signed certificate from a CA authority but since I'm hosting a server for myself &amp; my wife then I didn't bother to sign up for one.<br /><blockquote class="tr_bq">$ openssl genrsa -out server.key</blockquote>LibreSSL nicely defaults to a 2048 bit key, most tutorials you will find on the web still contain a flag for a 1024 bit key. OpenBSD has sane defaults so when in doubt - use them.<br /><br />Now that we have a key we need to sign a cert.<br /><blockquote class="tr_bq">$ openssl req -new -x509 -days 365 -key server.key -out server.crt<br />You are about to be asked to enter information that will be incorporated<br />into your certificate request.<br />What you are about to enter is what is called a Distinguished Name or a DN.<br />There are quite a few fields but you can leave some blank<br />For some fields there will be a default value,<br />If you enter '.', the field will be left blank.<br />-----<br />Country Name (2 letter code) []:PL<br />State or Province Name (full name) []:<br />Locality Name (eg, city) []:<br />Organization Name (eg, company) []:<br />Organizational Unit Name (eg, section) []:<br />Common Name (eg, fully qualified host name) []:cloud.example.com<br />Email Address []:adam.wolk@koparo.com</blockquote>Keys ready, so put them in a place that we can later on access from our httpd.conf.<br /><br /><blockquote class="tr_bq"># cp server.crt /etc/ssl/cloud.crt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br /># cp server.key /etc/ssl/private/cloud.crt</blockquote><br />ownCloud can work with multiple storage back-ends. I'm personally a fan of PostgreSQL so that's the back-end I will install for the ownCloud setup. It should be fairly trivial to adjust to your type of preferred back-end. So let us get PostgreSQL installed:<br /><blockquote class="tr_bq"># pkg_add postgresql-server</blockquote>To re-iterate for the last time. You <b>should </b>consult the pkg-readme for this package. The basic steps needed to go forward with ownCloud is to create a default database:<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; # su - _postgresql<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $ mkdir /var/postgresql/data<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; $ initdb -D /var/postgresql/data -U postgres -A md5 -W<br /><br />You should now alter your /etc/rc.conf.local script to have PostgreSQL start along with the system<br /><blockquote class="tr_bq"># cat /etc/rc.conf.local&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />ntpd_flags=<br />pkg_scripts="postgresql"</blockquote>Additionally starting the server now (if you don't want to reboot):<br /><blockquote class="tr_bq"># /etc/rc.d/postgresql start&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />postgresql(ok)</blockquote>Go back to the <i>_postgresql</i> account and prepare a database for ownCloud. You can use LibreSSL to generate a random password for the ownCloud account as demonstrated below:<br /><br /><blockquote class="tr_bq">$ openssl rand 16 -hex <br />d5a148be21b8f643105759af71bea852<br /><br />$ psql -U postgres<br />Password for user postgres: <br />psql (9.4.1)<br />Type "help" for help.</blockquote><blockquote>postgres=# CREATE USER owncloud WITH PASSWORD 'd5a148be21b8f643105759af71bea852';<br />CREATE ROLE<br />postgres=# CREATE DATABASE owncloud TEMPLATE template0 ENCODING 'UNICODE';<br />CREATE DATABASE<br />postgres=# ALTER DATABASE owncloud OWNER TO owncloud;<br />ALTER DATABASE<br />postgres=# GRANT ALL PRIVILEGES ON DATABASE owncloud TO owncloud;<br />GRANT</blockquote><br />Great, the database is ready. Now it's time to install ownCloud, php-fpm &amp; the php PostgreSQL drivers.<br /><br /><blockquote class="tr_bq"># pkg_add owncloud<br /># pkg_add php-fpm<br /># pkg_add php-pgsql<br /># pkg_add php-pdo_pgsql</blockquote><br />When prompted I had to pick the 5.5 series of the above php libraries. Depending on when you're performing your installation, the current default might have changed. The above commands will pull down some php libraries that we want to enable. In order to do so create symlinks as demonstrated below. Before you ask, pkg_add told you about it when the package was installed and you can always check pkg-readmes / man pages before randomly pasting commands from this blog. Who knows maybe one of them is a trap?<br /><blockquote class="tr_bq">ln -s /etc/php-5.5.sample/zip.ini /etc/php-5.5/zip.ini<br />ln -s /etc/php-5.5.sample/gd.ini /etc/php-5.5/gd.ini<br />ln -s /etc/php-5.5.sample/curl.ini /etc/php-5.5/curl.ini<br />ln -s /etc/php-5.5.sample/intl.ini /etc/php-5.5/intl.ini<br />ln -s /etc/php-5.5.sample/mcrypt.ini /etc/php-5.5/mcrypt.ini<br />ln -s /etc/php-5.5.sample/opcache.ini /etc/php-5.5/opcache.ini<br />ln -s /etc/php-5.5.sample/xmlrpc.ini /etc/php-5.5/xmlrpc.ini<br />ln -s /etc/php-5.5.sample/pdo_pgsql.ini /etc/php-5.5/pdo_pgsql.ini<br />ln -s /etc/php-5.5.sample/pgsql.ini /etc/php-5.5/pgsql.ini</blockquote>Owncloud really wants to work with UTF-8 and it will complain if php.ini is set to a different charset. So edit /etc/php-5.5.ini and make sure that <i>default_charset = "UTF-8"</i> is uncommented (doesn't have a ; at the beginning of the line).<br /><br />We are almost there I promise. For the impatient, all that's left to do is to configure httpd, finalize the ownCloud installation and set a cronjob for it.<br /><br />You might have heard that OpenBSD has a new httpd daemon. It so happens that the author of the software wrote a small <a href="https://github.com/reyk/httpd/wiki/Running-ownCloud-with-httpd-on-OpenBSD">github wiki</a> describing how to set it up with ownCloud. We will be basing our configuration heavily on that file so go read it first.<br /><br /><script src="https://gist.github.com/mulander/e0cb4f5e8594c67e78da.js"></script><br /><br />The main changes we made are:<br /><ul><li>disable HTTP completely (we only want HTTPS)</li><li>up the upload limit from 513M to 10GiB (don't ask me, ask my wife)</li><li>we point at the TLS certificates directly in case we want some other sites in the future using different key</li><li>we alter "*/data" to "*/data*" and "*/config" to "*/config*" as the previous rules didn't actually catch people trying to access critical files by name </li></ul>That's pretty much it. Remember to change "myowncloud.example.com" to your actual domain <strike>and to execute:</strike><br /><blockquote class="tr_bq"><pre><strike>mkdir -m 0 /var/www/forbidden</strike></pre></blockquote>The /var/www/forbidden workaround is no longer required as correctly pointed out by <a href="https://twitter.com/canadianbryan">Bryan Steele</a> on twitter. The block policy is now available for httpd as stated by <a href="http://www.openbsd.org/cgi-bin/man.cgi/OpenBSD-current/man5/httpd.conf.5?query=httpd.conf">httpd.conf(5)</a> manual page.<br /><br />You should of course save that config as /etc/httpd.conf.<br /><br />Finally alter your /etc/rc.conf.local to start both php-fpm and httpd. We will also start it manually in case you don't want to reboot ;)<br /><blockquote class="tr_bq"># cat /etc/rc.conf.local&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <br />ntpd_flags=<br />httpd_flags=""<br />pkg_scripts="postgresql php_fpm"</blockquote>In order to start manually issue:<br /><blockquote class="tr_bq">/etc/rc.d/php_fpm start<br />/etc/rc.d/httpd start</blockquote>Ok now go to the host you configured in your /etc/httpd.conf file. Your browser will probably give you a big scary warning because we self signed the certificate. Just confirm that it is actually your cert and add an exception. If you did everything correctly you should see a login/configuration page.<br /><div class="separator" style="clear: both; text-align: center;"><a href="http://2.bp.blogspot.com/-sdA08zr9uBo/VRbr3-EUNFI/AAAAAAAAEZo/QeGonmw-8Lk/s1600/2015-03-28-185812_318x821_scrot.png" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="http://2.bp.blogspot.com/-sdA08zr9uBo/VRbr3-EUNFI/AAAAAAAAEZo/QeGonmw-8Lk/s1600/2015-03-28-185812_318x821_scrot.png" height="320" width="123" /></a></div><br />Go ahead and pick a username for the cloud administrator. Leave the data folder to it's default location. Pick <b>PostgreSQL </b>as the database backend and enter the credentials we picked in previous steps (owncloud username &amp; database plus our random openssl generated password). You probably noticed that I'm entering 127.0.0.1 as the DB host. No need to provide a name there and risk that it doesn't resolve to what you expect. Done? Finish setup!<br /><br />Ok so everything is almost done. You should login to your new cloud and go to myowncloud.example.com/index.php/settings/admin and confirm that no configuration problems were found.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-3t9bwK56zh8/VRbt03N5nJI/AAAAAAAAEZ0/GIXu1NhcBMM/s1600/2015-03-28-190659_725x339_scrot.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-3t9bwK56zh8/VRbt03N5nJI/AAAAAAAAEZ0/GIXu1NhcBMM/s1600/2015-03-28-190659_725x339_scrot.png" height="149" width="320" /></a></div><br /><br />This is the finish line. The only thing left is a cron job for the service. ownCloud wants to perform periodical maintenance on a set interval. By default it will execute a <i>job</i> each time a page is accessed which is not an optimal solution. Instead we will set a cron job to run for the website every 15 minutes. If you did your homework and looked at the pkg-readmes then you already know everything about it ;) If not go ahead and read this final bit.<br /><br />We already know that httpd runs chrooted in /var/www. The pkg-readmes for ownCloud state that only Webcron will work inside a chroot so that's the option we will use. There is a tiny difference we will introduce. We completely disabled serving the site over HTTP so our cron job needs to fetch content over HTTPS. Now the <i>ftp </i>command which is used to do that in the cron job performs certificate validations and it <b>will fail</b> as our certificate is self signed. So we need to tell it to don't bother checking our cert. We can do this by adding a <b>-S dont</b> flag to the ftp command.<br /><br />We first need to edit the cron job for our service, httpd by default runs as user <b>www</b> so enter the following command to edit it's cron job:<br /><br /><blockquote class="tr_bq">crontab -u www -e</blockquote>And add the following cron entry<br /><br /><blockquote class="tr_bq">*/15&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; *&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /usr/bin/ftp -S dont -Vo - https://myowncloud.example.com/owncloud/cron.php &gt; /dev/null</blockquote>Remember to change myowncloud.example.com to your actual domain.<br />The final step is trivial and requires changing the owncloud setting in the admin panel from AJAX to Webcron.<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://4.bp.blogspot.com/-AzKo53V9yu8/VRbxSSBjqVI/AAAAAAAAEaA/HylyVVUjRIw/s1600/2015-03-28-192143_555x188_scrot.png" imageanchor="1" style="clear: left; float: left; margin-bottom: 1em; margin-right: 1em;"><img border="0" src="http://4.bp.blogspot.com/-AzKo53V9yu8/VRbxSSBjqVI/AAAAAAAAEaA/HylyVVUjRIw/s1600/2015-03-28-192143_555x188_scrot.png" height="108" width="320" /></a></div><br />That's it. You can verify that your cron is properly ticking by refreshing that page and seeing if the last cron execution is updated. Additionally if you check /var/cron/log you can see the executions performed by your OpenBSD cron and any errors that it might encounter.<br /><br />Got this far? Congratulations! You're done with a fully functional (as far as I am aware) ownCloud setup on an OpenBSD machine. Go ahead, make accounts and test the service. Most of all, have a ton of fun with it!<br /><br /><div class="separator" style="clear: both; text-align: center;"><a href="http://1.bp.blogspot.com/-54A_OWsUTeY/VRb3-bk_fGI/AAAAAAAAEaQ/c644kkXfSnM/s1600/2015-03-28-195013_445x71_scrot.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="http://1.bp.blogspot.com/-54A_OWsUTeY/VRb3-bk_fGI/AAAAAAAAEaQ/c644kkXfSnM/s1600/2015-03-28-195013_445x71_scrot.png" height="51" width="320" /></a></div><br />