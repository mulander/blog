---
layout: post
title: Go development on OpenBSD
date: '2015-03-21T12:33:00.001-07:00'
author: Adam Wo≈Çk
tags:
- go
- openbsd
- programming
modified_time: '2015-03-21T13:22:29.418-07:00'
blogger_id: tag:blogger.com,1999:blog-7611594305180455830.post-1840775298056500558
blogger_orig_url: http://homing-on-code.blogspot.com/2015/03/go-development-on-openbsd.html
---

<div class="separator" style="clear: both; text-align: center;"><a href="http://talks.golang.org/2013/advconc/gopherswrench.jpg" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="http://talks.golang.org/2013/advconc/gopherswrench.jpg" height="189" width="320" /></a></div>is perfectly fine. In this post I'll go over the tools I use, their setup and some pitfalls that you might encounter while first dipping your toes in lang/go on OpenBSD. I will also mention a new go related port I just submitted for review &amp; inclusion :)<br /><br /><br /><a name='more'></a><br /><br />My typical golang setup on Linux is nothing fancy. Sublime Text &amp; <a href="http://goconvey.co/">goconvey</a> pretty much sums it up completely. Go is also present in pretty much every Linux distro out there or trivial to compile on your own. How does OpenBSD stack up?<br /><br />If you are running a current snapshot (or 5.7 when it comes out) then you have go 1.4.1 available as a pre-built package from ports. The first step you need to take is to install it on your system:<br /><br /><blockquote class="tr_bq">pkg_add go</blockquote><br />The first trap you might fall into is not raising your system limits. Try to run your newly installed go package. A simple `go version` will do.<br /><br /><blockquote class="tr_bq">$ go version<br />runtime: panic before malloc heap initialized<br />fatal error: runtime: cannot reserve arena virtual address space<br /><br />runtime stack:<br />runtime.throw(0x854ce92)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /usr/local/go/src/runtime/panic.go:491 +0x83 fp=0xcfbcb6cc sp=0xcfbcb6b4<br />runtime.mallocinit()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /usr/local/go/src/runtime/malloc.c:223 +0xe9 fp=0xcfbcb708 sp=0xcfbcb6cc<br />runtime.schedinit()<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /usr/local/go/src/runtime/proc.c:137 +0x34 fp=0xcfbcb720 sp=0xcfbcb708<br />runtime.rt0_go(0xcfbcb7b4, 0xfff, 0x85470a0, 0x0, 0x0, 0x0, 0x57945d2b, 0xcfbcb76c, 0xcfbcb7b0, 0xcfbcb76c, ...)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /usr/local/go/src/runtime/asm_386.s:100 +0xed fp=0xcfbcb724 sp=0xcfbcb720<br />$ </blockquote>Oh my! Is it broken? Nope. OpenBSD is quite strict by default and applications are limited in the amount of RAM, file handles, cpu time etc. they can use. If you didn't hit that problem then your limits are either already raised or you ran the command as root (why would you do that?). Before you proceed with your development journey you should either raise those limits as documented in <a href="http://www.openbsd.org/cgi-bin/man.cgi/OpenBSD-current/man5/login.conf.5?query=login.conf">login.conf(5)</a> or if you're already in the staff group you can raise your limits for a single terminal. I personally prefer the second option as I think most applications (hello browsers) are too aggressive with resource usage and should be reminded more often that they are not the sole process in the system :)<br /><br />Here is the mantra I hit every time in a terminal before starting any go commands/editors:<br /><br /><blockquote class="tr_bq">export GOPATH=/home/mulander/go<br />export PATH=$PATH:$GOPATH/bin<br />ulimit -n 512<br />ulimit -p 512<br />ulimit -d 2036792</blockquote><br />The first two should be self explanatory if you did any golang development in the past. The other three handle your limits. No, this time `man ulimit` won't help you as they are shell built ins. If you're the adventurous type then you can go ahead and read the <a href="http://cvsweb.openbsd.org/cgi-bin/cvsweb/src/bin/ksh/c_ulimit.c?rev=1.19&amp;content-type=text/x-cvsweb-markup">source</a> for ulimit implementation or just read <a href="http://www.openbsd.org/cgi-bin/man.cgi/OpenBSD-current/man1/ksh.1?query=ksh">ksh(1)</a>. For those that believe me without going to the source/man page:<br /><ul><li>-n - sets the amount of file descriptors that can be open at once</li><li>-p - sets the amount of processes that can be run by the user at once</li><li>-d - sets the size limit (in kilobytes) on the size of the data area</li></ul>Setting an ulimit affects the shell and any processes that are created by this shell after a limit is imposed. <br /><br />Properly set limits will allow you to work with the go tool:<br /><br /><blockquote class="tr_bq">$ go version<br />go version go1.4.1 openbsd/386</blockquote><br />I mentioned Sublime Text in the passing and as you can guess there is no native binary for OpenBSD. Before switching to ST I was an eager emacs user and decided to give it another try for golang. So go ahread and:<br /><br /><blockquote class="tr_bq">pkg_add emacs</blockquote>I'm personally using the -gtk3 flavour of the port configured to use MELPA for package management (<a href="http://melpa.org/#/getting-started">go read about it</a>). For go development I installed the following packages:<br /><ul><li><a href="http://auto-complete.org/">auto-complete</a></li><li><a href="https://github.com/dominikh/go-mode.el">go-mode</a></li><li><a href="https://github.com/nsf/gocode">go-autocomplete</a> (don't forget to go get the binary itself!)</li><li><a href="https://github.com/syohex/emacs-go-eldoc">go-eldoc</a></li><li><a href="https://github.com/flycheck/flycheck">flycheck</a></li><li><a href="https://github.com/oneKelvinSmith/monokai-emacs">monokai-theme</a></li></ul>You can find my <a href="https://gist.github.com/mulander/74e1dfc1caee95825860">~/.emacs file here</a>.<br />So far I'm more than happy with the way emacs handles go code. All of the above extensions are in MELPA. I just linked them for the eye-candy demo's they all include on their pages (and their documentation!).<br /><br />By now we have a working go compiler &amp; a development environment/editor. What's next? For me it's goconvey which is a small golang app that runs in the background and constantly runs unit tests displaying a great summary of them in your browser by serving a page on localhost:8080 (default).<br /><br /><br />Installing <a href="http://goconvey.co/">goconvey</a> is trivial, just perform go get as noted on their page. What you will find tricky though is the first time you run the app with -cover=true - it will complain that the cover tool is not installed which is true since we didn't do that yet.<br /><br />This is the last significant pitfall you will encounter. Go will instruct you to go get the tool which will probably end up as follows:<br /><br /><blockquote class="tr_bq"><pre>$ go get golang.org/x/tools/cmd/cover <br />go install golang.org/x/tools/cmd/cover: open<br />/usr/local/go/pkg/tool/openbsd_386/cover: permission denied</pre></blockquote>What happens here is the result of a decision by the golang authors. The go tools want to install in a special $GOTOOLDIR which defaults to /usr/local/go/pkg/tool/openbsd_386/ on my system. Since this is outside your users directory the system correctly blocks write permission to it (you didn't run that as root did you?). So how to get the code coverage tool? You have two options.<br /><ol><li>Run the command as root (not recommended but I did that fallacy myself :()</li><li>Use my <a href="http://marc.info/?l=openbsd-ports&amp;m=142695568131623&amp;w=2">port</a></li></ol>I hope that by the time you are reading this the port will be pkg_add away. Generally I created a <a href="http://marc.info/?l=openbsd-ports&amp;m=142695568131623&amp;w=2">devel/gocover</a> port today that downloads the tools after I hit the same problem <a href="http://marc.info/?t=142686792400002&amp;r=1&amp;w=2">some time ago</a>, compiles the cover tool and installs it where go expects to find it. It's undergoing a review now on the ports@ mailing list and if all goes well should be imported to the ports tree. If you want to see this happen please download it, test it and report any problems to me :) While there you might also be interested in the <a href="http://marc.info/?t=142676032900001&amp;r=1&amp;w=2&amp;n=19">textproc/godoc</a> tool for a nice documentation browser for go packages, this one also hit the mailing list not so long ago.&nbsp; <br /><br />With the cover tool installed my personal requirements for a go development setup are met. I must say that I am pretty much satisfied with go on OpenBSD. The only drawback I still feel is the lack of the race detector tool:<br /><blockquote class="tr_bq">$ go test -race<br />go test: -race is only supported on linux/amd64, freebsd/amd64, darwin/amd64 and windows/amd64</blockquote>but I can live without it for the time being.<br /><br />Hope this helped you, happy Go hacking on OpenBSD. <br /><br /><blockquote class="tr_bq"><blockquote class="tr_bq"><blockquote class="tr_bq"></blockquote></blockquote></blockquote>