---
layout: post
title: How to learn a code base - rsync Part 2
date: '2011-05-22T15:38:00.000-07:00'
author: Adam Wołk
tags:
- snappy
- programming
- c
- rsync
modified_time: '2011-05-22T15:38:01.487-07:00'
thumbnail: http://4.bp.blogspot.com/-3lQaDsJoP6s/Tdf4whs-qjI/AAAAAAAADKQ/qDlH8oo5-xY/s72-c/snappynewrsynclogo.jpg
blogger_id: tag:blogger.com,1999:blog-7611594305180455830.post-7710460678183689316
blogger_orig_url: http://homing-on-code.blogspot.com/2011/05/how-to-learn-code-base-rsync-part-2.html
---

<div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><br /><a href="http://4.bp.blogspot.com/-3lQaDsJoP6s/Tdf4whs-qjI/AAAAAAAADKQ/qDlH8oo5-xY/s1600/snappynewrsynclogo.jpg" imageanchor="1" style="clear: right; float: right; margin-bottom: 1em; margin-left: 1em;"><img border="0" src="http://4.bp.blogspot.com/-3lQaDsJoP6s/Tdf4whs-qjI/AAAAAAAADKQ/qDlH8oo5-xY/s1600/snappynewrsynclogo.jpg" /></a>Now that we have a working setup with binaries built from source we can think about making modifications to the code.<br />The plan is to add support for <a href="http://code.google.com/p/snappy/">snappy</a> a recently released compression/decompression library developed in-house by Google.<br /><br /><br /><br /><br /><a name='more'></a><br /><span class="Apple-style-span" style="font-size: x-large;">Table of Contents</span></div></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><br /></div></div><ul><li><a href="{{ site.baseurl }}{% post_url 2011-05-07-how-to-learn-code-base-rsync-prologue %}">Prologue - Getting a bird's eye view</a></li><li><a href="{{ site.baseurl }}{% post_url 2011-05-15-how-to-learn-code-base-rsync-part-1 %}">Part 1 - Getting the source and compiling it</a> </li><li>Part 2 - This post</li></ul><div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><span class="Apple-style-span" style="font-size: x-large;">Part 2 - Making things snappy</span><br /><br />Before we start planning our changes, we need to take a step back and see how our compilation issue was resolved by the project maintainer. Our attempt to compile the code initially resulted in a problem with the linux/falloc.h header file missing on our system. We resolved the problem by replacing the include directive in rsync.h with an include of fcntl.h. We also sent a <a href="http://lists.samba.org/archive/rsync/2011-May/026324.html">report</a> of the encountered problem and the <a href="http://lists.samba.org/archive/rsync/2011-May/026325.html">applied solution</a> to the mailing list. The problem was later&nbsp;<a href="http://lists.samba.org/archive/rsync/2011-May/026328.html">reviewed</a> and <a href="http://gitweb.samba.org/?p=rsync.git;a=commitdiff;h=ac30d22ae5bd4e1a1282e401425fe28cec6a08bb;hp=8bcd6a4afff3cb8197d5589ec4fdf9fe153f53de">fixed</a> by the maintainer.<br /><br />The proper fix was to add a configuration check for the presence of the header file and conditionally include the header only if it's present. The additional include of fcntl.h we added to rsync.h is redundant because it's already done higher up in rsync.h - this was a mistake and we should have grep'ed for it in the first place.<br /><br />Let's fetch the newest code and recompile to see if everything passes nicely as expected.<br /><code><br />git fetch<br />git merge origin<br /></code><br />We are now on revision&nbsp;d518e02243c8a4aad550b402f3421720860f340e.<br /><br />It's now time to<br /><code><br />make reconfigure # we need this because our files changed after fetching the newest changes<br />make clean<br />./configure<br />make<br /><br />mulander@bunkier_mysli:~/code/blog/lac/rsync$ ./rsync --version<br />rsync &nbsp;version 3.1.0dev &nbsp;protocol version 31.PR13<br />Copyright (C) 1996-2011 by Andrew Tridgell, Wayne Davison, and others.<br />Web site: http://rsync.samba.org/<br />Capabilities:<br />&nbsp; &nbsp; 64-bit files, 64-bit inums, 32-bit timestamps, 64-bit long ints,<br />&nbsp; &nbsp; socketpairs, hardlinks, symlinks, IPv6, batchfiles, inplace,<br />&nbsp; &nbsp; append, ACLs, xattrs, iconv, symtimes, prealloc<br /><br />rsync comes with ABSOLUTELY NO WARRANTY. &nbsp;This is free software, and you<br />are welcome to redistribute it under certain conditions. &nbsp;See the GNU<br />General Public Licence for details.<br /></code><br /><div><br /></div><div>Everything went fine so let's talk a bit about our planned modification.</div><div><br /></div><div>The idea originated by observing <a href="http://www.mail-archive.com/rsync@lists.samba.org/msg27046.html">this thread</a> on the official rsync mailing list. The author is restoring a 6 TB backup which takes a long time to do. He observed that rsync is currently CPU bound maxing out one core of the machine - plenty of network&nbsp;bandwidth&nbsp;is available for use. Friendly folks at the mailing list suggested trying out two changes to reduce the CPU load. Turning off the delta-transfer algorithm is the first one and can be done by using the --whole-file option. The second suggestion is to drop compression this is done by <b>not</b>&nbsp;passing the --compress flag. The author claims that making both changes resulted in a 4.5 times transfer increase. Still rsync remained CPU bound even after these changes but no further discussion went on the mailing list.</div><div><br /></div><div>Now, we already can assume that changing the compression will not be the silver bullet to solving all problems. The point is that it's highly probable that there are rsync users not using any compression because of the CPU overhead it introduces during run-time. It's possible that these people would opt-in to a compression option which is an order of magnitude faster but has a smaller compression rate then the default provided by zlib. The most important point though is that this modification should be fun, not overly complicated and a really good way to learn a part of the code base faster.</div><div><br /></div><div>So what exactly is snappy? From the project home page:</div><div><div style="-webkit-border-horizontal-spacing: 2px; -webkit-border-vertical-spacing: 2px; line-height: 1.25em; max-width: 64em;"><span class="Apple-style-span" style="font-family: inherit;"><cite>Snappy is a compression/decompression library. It does not aim for maximum compression, or compatibility with any other compression library; instead, it aims for very high speeds and reasonable compression. For instance, compared to the fastest mode of zlib, Snappy is an order of magnitude faster for most inputs, but the resulting compressed files are anywhere from 20% to 100% bigger. On a single core of a Core i7 processor in 64-bit mode, Snappy compresses at about 250 MB/sec or more and decompresses at about 500 MB/sec or more.</cite></span></div><div style="-webkit-border-horizontal-spacing: 2px; -webkit-border-vertical-spacing: 2px; line-height: 1.25em; max-width: 64em;"><span class="Apple-style-span" style="font-family: inherit;"><br /></span></div><div style="-webkit-border-horizontal-spacing: 2px; -webkit-border-vertical-spacing: 2px; line-height: 1.25em; max-width: 64em;"><span class="Apple-style-span" style="font-family: inherit;"><cite>Snappy is widely used inside Google, in everything from BigTable and MapReduce to our internal RPC systems. (Snappy has previously been referred to as “Zippy” in some presentations and the likes.)</cite></span></div><br />We know that rsync is written in C. Fortunately for us snappy has an official C binding mentioned in the <a href="http://code.google.com/p/snappy/source/browse/trunk/README">README</a>&nbsp;in the Usage section - the bindings are kept in snappy-c.h.<br /><br />Here is the general plan of our modification.<br /><ol><li>Download and compile snappy locally</li><li>Write a simple C test to compress / decompress a file (just to get the hang of it)</li><li>See how zlib is handled by the build system</li><li>Add snappy to the build system and&nbsp;a configure step allowing to build rsync with/without snappy support</li><li>See where and how zlib is used in the code</li><li>Add an rsync flag --snappy-compress that makes rsync use snappy instead of zlib</li><li>Implement compression/decompression using snappy</li><li>Try out our modifications</li><li>Document the changes and send them upstream for a review</li></ol><div>Hopefully we will end up with an interesting change that we can submit upstream to the maintainer.<br /><br /><span class="Apple-style-span" style="font-size: large;">1. Getting snappy</span><br /><a href="http://code.google.com/p/snappy/downloads/detail?name=snappy-1.0.2.tar.gz&amp;can=2&amp;q=">Download</a> the 1.0.2 release of snappy. Unpack it and compile using:<br /><code><br />./configure<br />make<br /></code><br />I didn't encounter any problems with this step, you might consider installing it system wide with:<br /><code><br />make install<br /></code><br />It's also a good idea to refer to your distributions package manager instead of doing a system install from the sources.<br /><br /><span class="Apple-style-span" style="font-size: large;">2. Trying out snappy</span><br /><br />Before we add any code, it's a good idea just to try out simple things with the library. In order to do that I wrote a simple throw away program that I called test.c. The program opens a test.txt file from the current directory, compresses it's content and saves it to test.snappy as a final step the compressed content (from memory not the one saved on disk) is decompressed and saved to test.orig. I then did a simple diff to see if both files (test.txt and test.orig) are still the same after that pass.<br /><br /><script src="https://gist.github.com/985819.js?file=test.c"></script><br /><br /><span class="Apple-style-span" style="font-size: large;">3. How is zlib handled by the build system</span><br /><span class="Apple-style-span" style="font-family: inherit;">Initially I thought that seeing how zlib is plugged into the build system would be a good guide to adding support for snappy. Unfortunately zlib is a special case here since the rsync developers had to introduce rsync specific changes to it's code base so it's bundled with rsync and used in the build even if a system wide zlib installation is available. Forcing rsync to build against zlib without rsync specific modifications would make it impossible for this particular version to work with rsync built with the bundled library (most of the world).</span><br /><span class="Apple-style-span" style="font-size: large;"><br /></span><br /><span class="Apple-style-span" style="font-size: large;">4.&nbsp;Modifying&nbsp;the build system</span><br /><br /><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">In order to include snappy in the build system we need to add a header check for snappy-c.h to configure.ac. This allows us to make sure that the C bindings for the library are available in the system. If the header file is present a constant HAVE_SNAPPY_C initialized to 1 will be defined in config.h. This can be achieved by<span class="Apple-style-span" style="font-family: inherit;"><span class="Apple-style-span" style="line-height: 16px; white-space: pre;">&nbsp;adding snappy-c.h at the end of the AC_CHECK_HEADERS list (after linux/falloc.h).</span></span></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><br /></div><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">Additionally we will add&nbsp;an optional flag --with-snappy-compress required to be passed in order to build the feature. Since some people might not want the additional code we will make it disabled by default and compile the additions only when configure is explicitly called --with-snappy-compress.</div><span class="Apple-style-span" style="line-height: 16px; white-space: pre;"> </span><br /><span class="Apple-style-span" style="line-height: 16px; white-space: pre;"><span class="Apple-style-span" style="font-family: inherit;">We use AC_ARG_WITH in order to add the new flag and it's description.</span></span><br /><span class="Apple-style-span" style="line-height: 16px; white-space: pre;"><span class="Apple-style-span" style="font-family: inherit;">Later in the file we define an additional test starting with AC_MSG_CHECKING which checks if the --with-snappy-compress flag was provided to the configure script. If the flag was passed a new constant will be defined with the name </span></span><span class="Apple-style-span" style="line-height: 16px; white-space: pre;">SUPPORT_SNAPPY_COMPRESSION and initialization to 1.</span><br /><br /><span class="Apple-style-span" style="font-family: inherit;">We can see that our modifications work by calling:</span><br /><br /><code> <span class="Apple-style-span" style="font-family: inherit;">make reconfigure</span><br /><span class="Apple-style-span" style="font-family: inherit;">./configure --help</span><br /><span class="Apple-style-span" style="font-family: inherit;">... SNIP ...</span><br /><br /><span class="Apple-style-span" style="font-family: inherit;">Optional Packages:</span><br /><span class="Apple-style-span" style="font-family: inherit;">&nbsp; --with-PACKAGE[=ARG] &nbsp; &nbsp;use PACKAGE [ARG=yes]</span><br /><span class="Apple-style-span" style="font-family: inherit;">&nbsp; --without-PACKAGE &nbsp; &nbsp; &nbsp; do not use PACKAGE (same as --with-PACKAGE=no)</span><br /><span class="Apple-style-span" style="font-family: inherit;">&nbsp; --with-included-popt &nbsp; &nbsp;use bundled popt library, not from system</span><br /><span class="Apple-style-span" style="font-family: inherit;">&nbsp; --with-snappy-compress &nbsp;http://code.google.com/p/snappy/ faster than zlib</span><br /><span class="Apple-style-span" style="font-family: inherit;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; but worse compression</span><br /></code><br /><div style="font-size: x-large;"><code><span class="Apple-style-span" style="font-size: small;">... SNIP ...</span></code></div><br /><span class="Apple-style-span" style="font-family: inherit;">Here is the diff of the changes:</span><br /><script src="https://gist.github.com/985840.js">  </script><br /><br />Now that we have our constants figured out we can add a conditional include to rsync.h that will add the snappy-c.h header file if it's available and the --with-snappy-compress flag was provided:<br /><script src="https://gist.github.com/985860.js">  </script><br /><span class="Apple-style-span" style="font-family: inherit;"><br /></span><br /><span class="Apple-style-span" style="font-size: large;">5. Observing how zlib is being used</span><br /><br /><div style="margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;">We've read&nbsp;<a href="http://www.zlib.net/zlib_how.html">this usage example for zlib</a>&nbsp;in order to better understand how it might be used in the rsync code base. Next step was to grep inflate/deflate and zlib.h to find places where the library is used. This search resulted in:<br /><br /><ul><li>options.c - option parsing</li><li>batch.c - responsible for batch mode</li><li>token.c - code responsible for the actual file transfer</li></ul></div><div><b>options.c</b><br />This file is mostly responsible for parsing and initializing the options passed from the command line. The zlib.h header file is included here in order to access some constants defined in the header (for example the compression level) but actual compression/decompression code is not called here.<br /><b><br /></b><br /><b>batch.c</b><br />The batch mode is used to save time while performing rsync operations to a set of different hosts replicating the same source data. The batch writing is responsible for recording all the steps required to perform the same synchronization to a different host. Performing the write allows rsync to skip checking the file status, checksums and data block generation. The file is created using the --write-batch option and later replayed with the --read-batch option.<br />The zlib.h header file is included in batch.c not sure why as no code is called from it - probably in order to use some constants defined in the header. The do_compression flag is present on a list of flags with a comment marking the protocol version in which it was introduced. There is also a list of literal names for the flags. We will have to later on add --snappy-compress to this list in a similar fashion.</div><br /><b>token.c</b><br />Part of the code is responsible for deciding if a file is worth to be compressed and with what level of compression.&nbsp;Sending and receiving tokens/buffer of data both with compression enabled and disabled is also handled by functions in this file.<br />There seem to be three exported functions in this code.<br /><br /><ul><li>send_token - responsible for sending data. If compression is enabled it calls send_deflated_token&nbsp;otherwise simple_send_token is called. send_token is called from match.c</li><li>recv_token - responsible for getting data from the other end. If compression is enabled it calls recv_deflated_token otherwise simple_recv_token is called. recv_token is called from receiver.c</li><li>see_token - seems to be used to feed the zlib history buffer - not sure about this one. Will require more reading. see_token is called from receiver.c</li></ul><br />At this point I think our modification to token.c will end up with an introduction of two new functions recv_snappy_token and send_snappy_token - initially based on simple_send/recv_token.<br /><br />Overall we will have a lot of mundane testing ahead of us to see if our changes didn't break anything important ;)<br /><br /><span class="Apple-style-span" style="font-size: large;">6. Adding a --snappy-compress flag</span><br /><br />We want our changes to be transparent to the way rsync worked before. If someone used the --compress flag we still want to make sure that only the zlib code is being used. In order to use the snappy library the user will have to provide the --snappy-compress flag or both --compress and --snappy-compress. We will still implicitly set the --compress flag to true if the user just provides the --snappy-compress flag the reason behind this is not to skip code that could be not directly tied to zlib but still take part in compression/decompression (protocol handling? gathering statistics?). We will perform incremental changes and make additional modifications if we notice problems introduced by our changes.<br /><br />A quick grep of the code base revealed that the actual command line argument parsing takes place in option.c.<br /><br />All options in this file have a defined variable to store the parsed argument. We will define a new one called do_snappy_compression the name is based on the names of existing variables.<br /><br />The code in options.c also performs some other tasks, one of them is printing out the list of available features when rsync is called with the --version flag. The function responsible for this feature is called&nbsp;print_rsync_version and generally has a set of defined string constants initialized to "no ". After initialization each feature is checked (for example by checking if a compile time constant was defined) and set to an empty string if the feature is present. Further down each feature is printed via a printf wrapper called rprintf and the current value of the feature constant is printed before the feature name. The result of this is the string "no " printed before the feature name if it's not present or just the feature name if it's available.<br /><br />Next up is the usage function which is responsible for printing out a list of all the available flags and basic syntax the application handles. We will add our new flag along with a short description here guarded by a conditional based on the definition of SUPPORT_SNAPPY_COMPRESSION which we defined in rsync.h if the feature is available.<br /><br />According to it's documentation&nbsp;set_refuse_options is used to disable all the options the rsyncd.conf file defines to turn off. At this point I think this only refers to rsync working in daemon mode. Regular compression is handled there so we will remember to take a look here later on but for now we will skip modifying this part of the code.<br /><br />In parse_arguments we will add a conditional check based on do_snappy_compression. If our flag was provided we will additionally set do_compression to 1.<br /><br />Now let's recompile and check if our flag is present.<br /><code><br />mulander@bunkier_mysli:~/code/blog/lac/rsync$&nbsp;make<br /><br />mulander@bunkier_mysli:~/code/blog/lac/rsync$ ./rsync --help<br />... SNIP ...<br /><br /><span class="Apple-style-span" style="font-family: inherit;">&nbsp; &nbsp; &nbsp;--link-dest=DIR &nbsp; &nbsp; &nbsp; &nbsp; hardlink to files in DIR when unchanged</span><br /><span class="Apple-style-span" style="font-family: inherit;">&nbsp;-z, --compress &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;compress file data during the transfer</span><br /><span class="Apple-style-span" style="font-family: inherit;">&nbsp; &nbsp; &nbsp;--compress-level=NUM &nbsp; &nbsp;explicitly set compression level</span><br /><span class="Apple-style-span" style="font-family: inherit;">&nbsp; &nbsp; &nbsp;--snappy-compress &nbsp; &nbsp; &nbsp; use snappy compression instead of zlib</span><br /><span class="Apple-style-span" style="font-family: inherit;">&nbsp; &nbsp; &nbsp;--skip-compress=LIST &nbsp; &nbsp;skip compressing files with a suffix in LIST</span><br /></code><br /><div style="font-size: x-large;"><code><span class="Apple-style-span" style="font-size: small;">... SNIP ...</span></code></div><code><br /><span class="Apple-style-span" style="font-family: inherit;">mulander@bunkier_mysli:~/code/blog/lac/rsync$ ./rsync --version</span><br /><span class="Apple-style-span" style="font-family: inherit;">rsync &nbsp;version 3.1.0dev &nbsp;protocol version 31.PR13</span><br /><span class="Apple-style-span" style="font-family: inherit;">Copyright (C) 1996-2011 by Andrew Tridgell, Wayne Davison, and others.</span><br /><span class="Apple-style-span" style="font-family: inherit;">Web site: http://rsync.samba.org/</span><br /><span class="Apple-style-span" style="font-family: inherit;">Capabilities:</span><br /><span class="Apple-style-span" style="font-family: inherit;">&nbsp; &nbsp; 64-bit files, 64-bit inums, 32-bit timestamps, 64-bit long ints,</span><br /><span class="Apple-style-span" style="font-family: inherit;">&nbsp; &nbsp; socketpairs, hardlinks, symlinks, IPv6, batchfiles, inplace,</span><br /><span class="Apple-style-span" style="font-family: inherit;">&nbsp; &nbsp; append, ACLs, xattrs, iconv, symtimes, prealloc, snappy,</span><br /><span class="Apple-style-span" style="font-family: inherit;"><br /></span><br /><span class="Apple-style-span" style="font-family: inherit;">rsync comes with ABSOLUTELY NO WARRANTY. &nbsp;This is free software, and you</span><br /><span class="Apple-style-span" style="font-family: inherit;">are welcome to redistribute it under certain conditions. &nbsp;See the GNU</span><br /><span class="Apple-style-span" style="font-family: inherit;">General Public Licence for details.</span><br /></code><br /><div><div style="font-size: x-large;"><br /></div><span class="Apple-style-span" style="font-family: inherit;">Here is the listing of changes we introduced to options.c:</span><br /><script src="https://gist.github.com/985886.js">  </script><br /><div style="font-size: x-large;"><span class="Apple-style-span" style="font-size: small;"><br /></span><br /><span class="Apple-style-span" style="font-size: small;">That will be all as far as we are concerned today. The last three (biggest) steps are left for the next post(s). Implementing the actual code for compression/decompression. Making sure that everything works correctly. Creating a github clone of the official repository, storing the changes and notifying the maintainers on the mailing list.</span></div></div></div></div></div></div></div>